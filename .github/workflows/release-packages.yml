name: release-packages

on:
  push:
    branches:
      - main
    paths:
      - '**/Makefile'
  workflow_dispatch:

jobs:
  release:
    name: ${{ matrix.arch }}-${{ matrix.branch }} release
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        arch:
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_vfpv3-d16
          - arm_cortex-a9_neon
          - arm_cortex-a15_neon-vfpv4
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - mips64_octeonplus
          - i386_pentium4
          - x86_64
        branch:
          - openwrt-23.05
          - openwrt-24.10
          - openwrt-25.12
          - SNAPSHOT
        exclude:
          - arch: aarch64_cortex-a76
            branch: openwrt-23.05
          - arch: mips_4kec
            branch: openwrt-25.12
          - arch: mips_4kec
            branch: SNAPSHOT

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: build
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.branch }}
          FEEDNAME: nikki
          PACKAGES: nikki
          INDEX: 1
          KEY_BUILD: ${{ secrets.KEY_BUILD }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          NO_REFRESH_CHECK: true

      - name: prepare release files
        id: prepare
        run: |
          mkdir -p release_files

          # 根据分支类型确定文件类型
          if [[ "${{ matrix.branch }}" == "SNAPSHOT" ]]; then
            FILE_TYPE="apk"
            NIKKI_FILE=$(find bin/packages/ -name "nikki*.apk" -type f | head -n 1)
          else
            FILE_TYPE="ipk"
            NIKKI_FILE=$(find bin/packages/ -name "nikki*.ipk" -type f | head -n 1)
          fi

          if [ -n "$NIKKI_FILE" ]; then
            # 重命名文件: nikki_{架构}-{分支}.{文件类型}
            NEW_NAME="nikki_${{ matrix.arch }}-${{ matrix.branch }}.${FILE_TYPE}"
            cp "$NIKKI_FILE" "release_files/$NEW_NAME"
            echo "创建发布文件: $NEW_NAME"
            echo "nikki_file=$NEW_NAME" >> $GITHUB_OUTPUT
            echo "file_type=$FILE_TYPE" >> $GITHUB_OUTPUT
          else
            echo "错误: 找不到nikki ${FILE_TYPE}文件!"
            echo "搜索bin/packages/目录的所有文件:"
            find bin/packages/ -type f | sort
            exit 1
          fi

          echo "发布文件列表:"
          ls -la release_files/

      - if: github.event_name == 'push' && startsWith(github.ref_name, 'v')
        name: release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release_files/nikki_${{ matrix.arch }}-${{ matrix.branch }}.${{ matrix.branch == 'SNAPSHOT' && 'apk' || 'ipk' }}

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: nikki_${{ matrix.arch }}-${{ matrix.branch }}
          path: release_files/nikki_${{ matrix.arch }}-${{ matrix.branch }}.${{ matrix.branch == 'SNAPSHOT' && 'apk' || 'ipk' }}

  feed:
    needs: release
    name: feed
    runs-on: ubuntu-latest

    steps:
      - name: download
        uses: actions/download-artifact@v4
        with:
          pattern: nikki_*
          merge-multiple: true
          path: ./packages

      - name: prepare
        run: |
          mkdir -p public

          # 遍历下载的包文件，按分支/架构分类存放
          for file in ./packages/nikki_*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # 解析文件名: nikki_{arch}-{branch}.{ext}
              if [[ "$filename" =~ ^nikki_(.+)-([^.]+)\.(ipk|apk)$ ]]; then
                arch="${BASH_REMATCH[1]}"
                branch="${BASH_REMATCH[2]}"
                ext="${BASH_REMATCH[3]}"

                mkdir -p "public/$branch/$arch"
                cp "$file" "public/$branch/$arch/"
                echo "已存放: $branch/$arch/$filename"
              fi
            fi
          done

          echo "生成的目录结构:"
          find public -type f | sort

      - name: feed
        uses: cloudflare/wrangler-action@v3
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: pages deploy public --project-name=nikkinikki
