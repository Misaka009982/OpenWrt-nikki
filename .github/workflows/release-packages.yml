name: release-packages

on:
  push:
    branches:
      - main
    paths:
      - 'nikki/Makefile'
      - '**/Makefile'
  workflow_dispatch:

jobs:
# ========================
# 1️⃣ 提取版本 & 创建 Tag
# ========================
  version:
    name: extract version and create tag
    runs-on: ubuntu-latest
    outputs:
      build_version: ${{ steps.version.outputs.build_version }}
      source_date: ${{ steps.version.outputs.source_date }}
      pkg_version: ${{ steps.version.outputs.pkg_version }}
      pkg_name: ${{ steps.version.outputs.pkg_name }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: extract version and create tag
        id: version
        run: |
          MAKEFILE_PATH="nikki/Makefile"
          [ -f "$MAKEFILE_PATH" ] || MAKEFILE_PATH=$(find . -type f -name "Makefile" | head -n 1)

          PKG_BUILD_VERSION=$(grep "PKG_BUILD_VERSION:=" -m1 "$MAKEFILE_PATH" | cut -d '=' -f2 | tr -d ' ')
          PKG_SOURCE_DATE=$(grep "PKG_SOURCE_DATE:=" -m1 "$MAKEFILE_PATH" | cut -d '=' -f2 | tr -d ' ')
          PKG_NAME=$(grep "PKG_NAME:=" -m1 "$MAKEFILE_PATH" | cut -d '=' -f2 | tr -d ' ')
          PKG_VERSION=$(grep "PKG_SOURCE_VERSION:=" -m1 "$MAKEFILE_PATH" | cut -d '=' -f2 | tr -d ' ' | cut -c1-8)

          [ -n "$PKG_BUILD_VERSION" ] || PKG_BUILD_VERSION="1.0.0"
          [ -n "$PKG_SOURCE_DATE" ] || PKG_SOURCE_DATE=$(date +%Y-%m-%d)

          TAG_NAME="Nikki-v$PKG_BUILD_VERSION"

          echo "build_version=$PKG_BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "source_date=$PKG_SOURCE_DATE" >> $GITHUB_OUTPUT
          echo "pkg_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          if ! git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            git config user.name github-actions
            git config user.email action@github.com
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
            git push origin "$TAG_NAME"
          fi

# ========================
# 2️⃣ 构建 & Release
# ========================
  release:
    name: ${{ matrix.arch }}-${{ matrix.display_version }} release
    needs: version
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, 'update mihomo to')
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          # ---------- openwrt-23.05.5 架构 ----------
          - arch: arm_cortex-a5_vfpv4
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: arm_cortex-a7_neon-vfpv4
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: arm_cortex-a8_vfpv3
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: arm_cortex-a9
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: arm_cortex-a9_vfpv3-d16
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: arm_cortex-a9_neon
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: arm_cortex-a15_neon-vfpv4
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: aarch64_cortex-a53
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: aarch64_cortex-a72
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: aarch64_generic
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mips_24kc
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mips_4kec
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mips_mips32
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mipsel_24kc
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mipsel_24kc_24kf
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mipsel_74kc
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mipsel_mips32
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: mips64_octeonplus
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          - arch: i386_pentium4
            sdk_branch: openwrt-23.05
            display_version: 23.05.5
          # ---------- openwrt-24.10 架构 ----------
          - arch: x86_64
            sdk_branch: openwrt-24.10
            display_version: 24.10
          # ---------- SNAPSHOT 架构 ----------
          - arch: aarch64_cortex-a76
            sdk_branch: SNAPSHOT
            display_version: SNAPSHOT

    steps:
      - uses: actions/checkout@v4

      - name: build
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk_branch }}
          FEEDNAME: nikki
          PACKAGES: luci-app-nikki
          INDEX: 0
          NO_REFRESH_CHECK: true
          BUILD_LOG: "V=sc"
          BUILD_OPTS: "-j$(nproc) --force-depends"
          IGNORE_ERRORS: "1"
          IGNORE_DEPS: "1"
          EXTRA_PKGS: "libc ca-bundle curl yq firewall4 ip-full kmod-inet-diag kmod-nft-socket kmod-nft-tproxy kmod-tun luci-base"
          SNAPSHOT: ${{ matrix.sdk_branch == 'SNAPSHOT' }}

      - name: prepare release files
        run: |
          mkdir -p release_files

          if [ "${{ matrix.sdk_branch }}" = "SNAPSHOT" ]; then
            FILE=$(find bin/packages -name "nikki-*.apk" | head -n1)
            EXT=apk
          else
            FILE=$(find bin/packages -name "nikki_*.ipk" | head -n1)
            EXT=ipk
          fi

          if [ ! -f "$FILE" ]; then
            echo "❌ 未找到产物"
            find bin/packages -type f | sort
            exit 1
          fi

          NAME="nikki-v${{ needs.version.outputs.build_version }}-${{ matrix.arch }}-${{ matrix.display_version }}.$EXT"
          cp "$FILE" "release_files/$NAME"

      - uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.version.outputs.tag_name }}
          tag_name: ${{ needs.version.outputs.tag_name }}
          body: "同步${{ needs.version.outputs.source_date }} mihomo v${{ needs.version.outputs.build_version }}"
          files: release_files/*

      - uses: actions/upload-artifact@v4
        with:
          name: nikki-${{ matrix.arch }}-${{ matrix.display_version }}
          path: release_files/*

# ========================
# 3️⃣ Feed
# ========================
  feed:
    needs: release
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: nikki-*
          merge-multiple: true
          path: downloaded

      - run: |
          mkdir -p public
          for f in downloaded/*; do
            name=$(basename "$f")
            if [[ "$name" =~ nikki-v.+-(.+)-(.+)\.(ipk|apk)$ ]]; then
              arch=${BASH_REMATCH[1]}
              branch=${BASH_REMATCH[2]}
              ext=${BASH_REMATCH[3]}
              mkdir -p public/$branch/$arch
              cp "$f" public/$branch/$arch/nikki.$ext
            fi
          done

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          force_orphan: true
          commit_message: "release: 同步${{ needs.version.outputs.source_date }} mihomo v${{ needs.version.outputs.build_version }}"
