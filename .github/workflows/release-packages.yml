name: release-packages

on:
  workflow_dispatch:
  push:
    tags:
      - Nikki-*

jobs:
  release:
    name: ${{ matrix.arch }}-${{ matrix.branch }} release
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64_cortex-a53
        branch:
          - openwrt-23.05

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: extract version and create tag
        id: version
        run: |
          # 从Makefile中提取PKG_BUILD_VERSION
          PKG_BUILD_VERSION=$(grep "PKG_BUILD_VERSION:=" -m 1 Makefile | cut -d '=' -f2 | tr -d ' ')
          echo "Building version: $PKG_BUILD_VERSION"
          
          # 设置标签名
          TAG_NAME="Nikki-v$PKG_BUILD_VERSION"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # 检查标签是否已存在
          if ! git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            # 创建并推送标签
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
            git push origin "$TAG_NAME"
            echo "Created and pushed new tag: $TAG_NAME"
          else
            echo "Tag $TAG_NAME already exists, skipping tag creation"
          fi

      - name: build
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.branch }}
          FEEDNAME: nikki
          PACKAGES: "luci-app-nikki"
          INDEX: 0
          NO_REFRESH_CHECK: true
          BUILD_LOG: "V=sc"
          BUILD_OPTS: "-j1 --force-depends"
          IGNORE_ERRORS: "1"
          IGNORE_DEPS: "1"
          EXTRA_PKGS: "libc ca-bundle curl yq firewall4 ip-full kmod-inet-diag kmod-nft-socket kmod-nft-tproxy kmod-tun luci-base"

      - name: compress
        run: |
          mkdir -p bin/packages/${{ matrix.arch }}/nikki
          mkdir -p public/${{ matrix.branch }}/${{ matrix.arch }}
          
          # 创建一个空的README文件，确保目录不为空
          echo "This directory intentionally left empty" > bin/packages/${{ matrix.arch }}/nikki/README.md
          
          tar -c -z -f nikki_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz -C bin/packages/${{ matrix.arch }}/nikki .
          mv bin/packages/${{ matrix.arch }}/nikki public/${{ matrix.branch }}/${{ matrix.arch }}
          tar -c -z -f feed_nikki_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz public/${{ matrix.branch }}/${{ matrix.arch }}

      - name: release
        if: startsWith(github.ref, 'refs/tags/Nikki-')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            nikki_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: feed_nikki_${{ matrix.arch }}-${{ matrix.branch }}
          path: feed_nikki_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz

  feed:
    needs: release
    name: feed
    runs-on: ubuntu-latest

    steps:
      - name: download
        uses: actions/download-artifact@v4
        with:
          pattern: feed_nikki_*
          merge-multiple: true
      
      - name: uncompress
        run: |
          for file in feed_nikki_*.tar.gz; do tar -x -z -f "$file"; done
      
      - name: feed
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force_orphan: true
          commit_message: "release: ${{ github.ref_name }}"
