name: release-packages

on:
  workflow_dispatch:
  push:
    tags:
      - v*

jobs:
  # 查询各分支的最新具体版本号
  resolve-versions:
    name: resolve latest versions
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.resolve.outputs.versions }}
    steps:
      - name: resolve latest versions
        id: resolve
        run: |
          # 定义要查询的主版本
          BRANCHES=("23.05" "24.10")

          VERSIONS="["
          FIRST=true

          for BRANCH in "${BRANCHES[@]}"; do
            # 从 OpenWrt 下载页面获取最新版本号
            LATEST=$(curl -s "https://downloads.openwrt.org/releases/" | \
              grep -oP "${BRANCH}\.\d+" | \
              sort -V | \
              tail -n 1)

            if [ -n "$LATEST" ]; then
              echo "分支 ${BRANCH} 的最新版本: ${LATEST}"
              if [ "$FIRST" = true ]; then
                VERSIONS="${VERSIONS}\"${LATEST}\""
                FIRST=false
              else
                VERSIONS="${VERSIONS},\"${LATEST}\""
              fi
            else
              echo "警告: 无法获取 ${BRANCH} 的最新版本，使用默认值"
              if [ "$FIRST" = true ]; then
                VERSIONS="${VERSIONS}\"${BRANCH}.0\""
                FIRST=false
              else
                VERSIONS="${VERSIONS},\"${BRANCH}.0\""
              fi
            fi
          done

          # 添加 SNAPSHOT
          VERSIONS="${VERSIONS},\"SNAPSHOT\"]"

          echo "最终版本列表: $VERSIONS"
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

  release:
    name: ${{ matrix.arch }}-${{ matrix.version }} release
    needs: resolve-versions
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64_cortex-a53
        version: ${{ fromJson(needs.resolve-versions.outputs.versions) }}

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: build
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.version }}
          FEEDNAME: nikki
          PACKAGES: nikki
          INDEX: 1
          KEY_BUILD: ${{ secrets.KEY_BUILD }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          NO_REFRESH_CHECK: true

      - name: prepare release files
        id: prepare
        run: |
          mkdir -p release_files

          # 根据版本类型确定文件类型
          if [[ "${{ matrix.version }}" == "SNAPSHOT" ]]; then
            FILE_TYPE="apk"
            NIKKI_FILE=$(find bin/packages/ -name "nikki*.apk" -type f | head -n 1)
          else
            FILE_TYPE="ipk"
            NIKKI_FILE=$(find bin/packages/ -name "nikki*.ipk" -type f | head -n 1)
          fi

          if [ -n "$NIKKI_FILE" ]; then
            # 重命名文件: nikki_{架构}-{版本}.{文件类型}
            NEW_NAME="nikki_${{ matrix.arch }}-${{ matrix.version }}.${FILE_TYPE}"
            cp "$NIKKI_FILE" "release_files/$NEW_NAME"
            echo "创建发布文件: $NEW_NAME"
            echo "nikki_file=$NEW_NAME" >> $GITHUB_OUTPUT
            echo "file_type=$FILE_TYPE" >> $GITHUB_OUTPUT
          else
            echo "错误: 找不到nikki ${FILE_TYPE}文件!"
            echo "搜索bin/packages/目录的所有文件:"
            find bin/packages/ -type f | sort
            exit 1
          fi

          echo "发布文件列表:"
          ls -la release_files/

      - if: github.event_name == 'push' && startsWith(github.ref_name, 'v')
        name: release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release_files/nikki_${{ matrix.arch }}-${{ matrix.version }}.${{ matrix.version == 'SNAPSHOT' && 'apk' || 'ipk' }}

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: nikki_${{ matrix.arch }}-${{ matrix.version }}
          path: release_files/nikki_${{ matrix.arch }}-${{ matrix.version }}.${{ matrix.version == 'SNAPSHOT' && 'apk' || 'ipk' }}

  feed:
    needs: release
    name: feed
    runs-on: ubuntu-latest

    steps:
      - name: download
        uses: actions/download-artifact@v4
        with:
          pattern: nikki_*
          merge-multiple: true
          path: ./packages

      - name: prepare
        run: |
          mkdir -p public

          # 遍历下载的包文件，按版本/架构分类存放
          for file in ./packages/nikki_*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # 解析文件名: nikki_{arch}-{version}.{ext}
              if [[ "$filename" =~ ^nikki_(.+)-([0-9.]+|SNAPSHOT)\.(ipk|apk)$ ]]; then
                arch="${BASH_REMATCH[1]}"
                version="${BASH_REMATCH[2]}"
                ext="${BASH_REMATCH[3]}"

                mkdir -p "public/$version/$arch"
                cp "$file" "public/$version/$arch/"
                echo "已存放: $version/$arch/$filename"
              fi
            fi
          done

          echo "生成的目录结构:"
          find public -type f | sort

      - name: feed
        uses: cloudflare/wrangler-action@v3
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: pages deploy public --project-name=nikkinikki
