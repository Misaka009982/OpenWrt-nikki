name: release-packages
on:
  workflow_dispatch:
  push:
    tags:
      - v*

jobs:
  release:
    name: ${{ matrix.arch }}-${{ matrix.branch }} release
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64_cortex-a53
          - mipsel_24kc
        branch:
          - openwrt-23.05
        exclude:
          - arch: aarch64_cortex-a53
            branch: openwrt-23.05  # 假设此分支不支持该架构

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenWrt SDK
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.branch }}

      - name: Prepare Dependencies
        run: |
          echo "src-git packages https://github.com/openwrt/packages.git;${{ matrix.branch }}" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig
          # 修复已知配置冲突
          sed -i 's/CONFIG_PACKAGE_ca-bundle=.*/CONFIG_PACKAGE_ca-bundle=y/' .config

      - name: Build Packages
        run: make -j$(nproc) package/luci-app-nikki/compile V=s

      - name: Compress Artifacts
        run: |
          mkdir -p public/${{ matrix.branch }}/${{ matrix.arch }}
          cp bin/packages/*/nikki/*.ipk public/${{ matrix.branch }}/${{ matrix.arch }}
          tar -czf nikki_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz -C public .

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: nikki_*.tar.gz

  feed:
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
