name: dependabot

on:
  schedule:
    - cron: "0 0 * * *"  # 每天UTC 0点自动检查
  workflow_dispatch:     # 允许手动触发

jobs:
  get_current_info:
    runs-on: ubuntu-latest
    outputs:
      pkg_source_version: ${{ steps.info.outputs.pkg_source_version }}
      pkg_mirror_hash: ${{ steps.info.outputs.pkg_mirror_hash }}
      pkg_build_version: ${{ steps.info.outputs.pkg_build_version }}
    steps:
      - name: Checkout OpenWrt-nikki
        id: checkout
        uses: actions/checkout@v4
        with:
          repository:Misaka009982/OpenWrt-nikki
          ref: main
          path: OpenWrt-nikki

      - name: Extract Current Package Info
        id: info
        run: |
          makefile="OpenWrt-nikki/nikki/Makefile"
          echo "pkg_source_version=$(grep "PKG_SOURCE_VERSION:=" $makefile | cut -d '=' -f 2)" >> $GITHUB_OUTPUT
          echo "pkg_mirror_hash=$(grep "PKG_MIRROR_HASH:=" $makefile | cut -d '=' -f 2)" >> $GITHUB_OUTPUT
          echo "pkg_build_version=$(grep "PKG_BUILD_VERSION:=" $makefile | cut -d '=' -f 2)" >> $GITHUB_OUTPUT

  get_latest_release:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
      commit_sha: ${{ steps.release_info.outputs.commit_sha }}
      checksum: ${{ steps.release_info.outputs.checksum }}
      release_date: ${{ steps.release_info.outputs.release_date }}
    steps:
      - name: Get Latest Release Metadata
        id: release_info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get -qq install jq
          release_json=$(curl -sH "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)
          tag_name=$(jq -r '.tag_name' <<< "$release_json")
          release_date=$(jq -r '.published_at' <<< "$release_json" | cut -d'T' -f1)
          tag_info=$(curl -sH "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/MetaCubeX/mihomo/git/ref/tags/$tag_name")
          commit_sha=$(jq -r '.object.sha' <<< "$tag_info")
          sha_file_url="https://github.com/MetaCubeX/mihomo/releases/download/$tag_name/SHA256SUMS"
          sha_content=$(curl -sL "$sha_file_url")
          checksum=$(grep "mihomo-linux-arm64-${tag_name#v}.gz" <<< "$sha_content" | awk '{print $1}')
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          echo "commit_sha=$commit_sha" >> $GITHUB_OUTPUT
          echo "checksum=$checksum" >> $GITHUB_OUTPUT
          echo "release_date=$release_date" >> $GITHUB_OUTPUT

  update:
    needs: [get_current_info, get_latest_release]
    if: ${{ needs.get_current_info.outputs.pkg_source_version != needs.get_latest_release.outputs.commit_sha }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout OpenWrt-nikki
        uses: actions/checkout@v4
        with:
          repository:Misaka009982/OpenWrt-nikki
          ref: main
          path: OpenWrt-nikki
          persist-credentials: true  # 保持Git凭证
          fetch-depth: 0             # 获取完整提交历史
          # 确保远程仓库信息正确
          remote-name: origin
          submodules: recursive

      - name: Configure Git Safe Directory
        run: |
          git config --global --add safe.directory /__w/OpenWrt-nikki/OpenWrt-nikki

      - name: Update Makefile
        run: |
          makefile_path="OpenWrt-nikki/nikki/Makefile"
          # 删除可能的备份文件
          rm -f "${makefile_path}.bak"
          # 直接修改文件
          sed -i \
            -e "s/PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=${{ needs.get_latest_release.outputs.commit_sha }}/" \
            -e "s/PKG_MIRROR_HASH:=.*/PKG_MIRROR_HASH:=${{ needs.get_latest_release.outputs.checksum }}/" \
            -e "s/PKG_BUILD_VERSION:=.*/PKG_BUILD_VERSION:=${tag_name#v}/" \
            "$makefile_path"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: OpenWrt-nikki
          # 明确指定分支名称
          branch: dependabot
          # 指定目标仓库
          repository:Misaka009982/OpenWrt-nikki
          # 指定基础分支
          base: main
          # 自动删除合并后的分支
          delete-branch: true
          # 提交信息
          commit-message: "build(mihomo): update to ${{ needs.get_latest_release.outputs.tag_name }}"
          # PR标题
          title: "build: update mihomo to ${{ needs.get_latest_release.outputs.tag_name }}"
          # PR内容
          body: |
            ## 更新详情
            - **版本**: [${{ needs.get_latest_release.outputs.tag_name }}](https://github.com/MetaCubeX/mihomo/releases/tag/${{ needs.get_latest_release.outputs.tag_name }})
            - **提交**: [${{ needs.get_latest_release.outputs.commit_sha }}](https://github.com/MetaCubeX/mihomo/commit/${{ needs.get_latest_release.outputs.commit_sha }})
            - **变更日志**: [差异对比](https://github.com/MetaCubeX/mihomo/compare/${{ needs.get_current_info.outputs.pkg_source_version }}...${{ needs.get_latest_release.outputs.commit_sha }})
